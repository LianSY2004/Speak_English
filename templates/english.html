<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‹±æ–‡å£èªªæ¸¬é©— - SpeakEnglish</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
        padding-top: 80px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      header {
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 70px;
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        height: 100%;
      }

      .logo {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        flex: 1;
      }

      .nav-menu {
        display: flex;
        gap: 40px;
        flex: 1;
        justify-content: center;
        align-items: center;
      }

      .nav-menu a {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-menu a:hover {
        color: #3498db;
      }

      /* æ·»åŠ ä¸€å€‹ç©ºçš„ div ä¾†å¹³è¡¡ä½ˆå±€ */
      .nav-spacer {
        flex: 1;
      }

      .main-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h2 {
        text-align: center;
        margin-bottom: 30px;
      }

      /* é¡Œç›®å®¹å™¨æ”¹ç‚º flex ä½ˆå±€ */
      .question-container {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        align-items: flex-start;
      }

      .question-box {
        background-color: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        flex: 1;
        min-height: 100px;
        box-sizing: border-box;
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
      }

      .question-box p {
        margin: 0;
        text-align: left;
      }

      /* ä¸­æ–‡ç¿»è­¯å€åŸŸ */
      .translation-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .translation-toggle {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        white-space: nowrap;
      }

      .translation-toggle:hover {
        background-color: #2980b9;
      }

      .translation-box {
        background-color: #e8f4fd;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        min-width: 200px;
        max-width: 300px;
        display: none;
      }

      .translation-box.show {
        display: block;
      }

      .translation-box p {
        margin: 0;
        color: #2c3e50;
        font-size: 14px;
        line-height: 1.5;
      }

      .answer-section {
        margin-bottom: 25px;
      }
      .answer-label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        text-align: left;
      }
      textarea {
        width: 100%;
        min-height: 150px;
        padding: 12px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
        font-size: 16px;
      }
      .button-group {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }
      button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #2980b9;
      }
      .result-container {
        margin-top: 30px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        text-align: left;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: inherit;
        font-size: inherit;
      }
      .microphone-status {
        margin-top: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .mic-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #ccc;
        display: inline-block;
        transition: background-color 0.3s;
      }
      .mic-indicator.connected {
        background-color: #27ae60;
      }
      .mic-indicator.error {
        background-color: #e74c3c;
      }
      #mic-status {
        font-size: 14px;
        color: #666;
        margin: 0;
      }
      .mic-icon {
        font-size: 18px;
        margin-right: 5px;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .nav-menu {
          display: none; /* åœ¨å°è¢å¹•éš±è—å°èˆªé¸å–® */
        }

        .nav-spacer {
          display: none; /* åœ¨å°è¢å¹•éš±è—é–“è· */
        }

        body {
          padding-top: 60px; /* å°è¢å¹•æ™‚æ¸›å°‘é ‚éƒ¨é–“è· */
        }

        header {
          height: 60px;
        }

        /* æ‰‹æ©Ÿç‰ˆæ”¹ç‚ºå‚ç›´ä½ˆå±€ */
        .question-container {
          flex-direction: column;
        }

        .translation-area {
          align-items: flex-start;
        }

        .translation-box {
          min-width: auto;
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <div class="logo">SpeakEnglish</div>
        <div class="nav-menu">
          <a href="{{ url_for('feature') }}">åŠŸèƒ½</a>
          <a href="{{ url_for('contact') }}">è¯çµ¡æˆ‘å€‘</a>
        </div>
        <div class="nav-spacer"></div>
      </nav>
    </header>

    <div class="main-container">
      <h2>è«‹å›ç­”ä¸‹åˆ—å•é¡Œï¼š</h2>

      <div class="question-container">
        <div class="question-box">
          <p id="question-display"><strong>{{ question }}</strong></p>
        </div>

        <div class="translation-area">
          <button class="translation-toggle" onclick="toggleTranslation()">
            <span id="toggle-text">é¡¯ç¤ºä¸­æ–‡</span>
          </button>
          <div class="translation-box" id="translation-box">
            <p id="translation-text">{{ chinese_translation }}</p>
          </div>
        </div>
      </div>

      <form method="POST" id="qa-form">
        <div class="answer-section">
          <label class="answer-label">ä½ çš„å›ç­”ï¼š</label>
          <textarea name="user_answer" id="user-answer"></textarea>

          <!-- éŒ„éŸ³æ§åˆ¶æŒ‰éˆ• -->
          <button
            type="button"
            id="rec-btn"
            style="margin-top: 8px"
            onclick="AndroidNative.startVoice()"
          >
            ğŸ¤ é–‹å§‹éŒ„éŸ³
          </button>
          <span id="rec-hint" style="margin-left: 8px; color: #888"></span>

          <!-- éº¥å…‹é¢¨ç‹€æ…‹æª¢æ¸¬å€åŸŸï¼ˆåŸæœ¬åŠŸèƒ½ä¿ç•™ï¼‰ -->
          <div class="microphone-status">
            <span class="mic-icon">ğŸ¤</span>
            <div id="mic-indicator" class="mic-indicator"></div>
            <span id="mic-status">æª¢æ¸¬éº¥å…‹é¢¨ä¸­...</span>
          </div>
        </div>

        <div class="button-group">
          {% if show_next %}
          <button type="submit" name="action" value="next">ä¸‹ä¸€é¡Œ</button>
          {% endif %} {% if show_end %}
          <button type="submit" name="action" value="finish">å®Œæˆæ¸¬é©—</button>
          {% endif %}
        </div>
      </form>

      {% if result %}
      <div class="result-container">
        <h3>è©•åˆ†çµæœï¼š</h3>
        <pre>{{ result }}</pre>
      </div>
      {% endif %}
    </div>

    <!-- åŸç”Ÿéº¥å…‹é¢¨æª¢æ¸¬è…³æœ¬ -->
    {{ microphone_script|safe }}

    <!-- ä¸­æ–‡ç¿»è­¯åˆ‡æ›åŠŸèƒ½ -->
    <script>
      function toggleTranslation() {
        const box = document.getElementById("translation-box");
        const toggleText = document.getElementById("toggle-text");

        if (box.classList.contains("show")) {
          box.classList.remove("show");
          toggleText.textContent = "é¡¯ç¤ºä¸­æ–‡";
        } else {
          box.classList.add("show");
          toggleText.textContent = "éš±è—ä¸­æ–‡";
        }
      }
    </script>

    <!-- Web Speech APIï¼šå³æ™‚èªéŸ³è½‰æ–‡å­— -->
    <script>
      (() => {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          document.getElementById("rec-btn").style.display = "none";
          document.getElementById("rec-hint").textContent =
            "ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥";
          return;
        }

        const recog = new SpeechRecognition();
        recog.lang = "en-US"; // æ”¹æˆ "zh-TW" å¯è¾¨ä¸­æ–‡
        recog.interimResults = true; // å³æ™‚çµæœ
        recog.continuous = false; // åœé “å³ onend

        const btn = document.getElementById("rec-btn");
        const hint = document.getElementById("rec-hint");
        const textarea = document.getElementById("user-answer");

        let listening = false;

        btn.addEventListener("click", () => {
          listening ? recog.stop() : recog.start();
        });

        recog.onstart = () => {
          listening = true;
          btn.textContent = "â¹ åœæ­¢éŒ„éŸ³";
          hint.textContent = "éŒ„éŸ³ä¸­â€¦ èªªå®Œå†æŒ‰ä¸€æ¬¡";
        };

        recog.onresult = (e) => {
          let text = "";
          for (let i = 0; i < e.results.length; ++i) {
            text += e.results[i][0].transcript;
          }
          textarea.value = text.trim();
          if (e.results[e.results.length - 1].isFinal) {
            hint.textContent = "å·²å¡«å…¥æ–‡å­—ï¼Œå¯ç·¨è¼¯å¾Œé€å‡º";
          }
        };

        recog.onend = () => {
          listening = false;
          btn.textContent = "ğŸ¤ é–‹å§‹éŒ„éŸ³";
          // è‹¥ textarea å·²æœ‰å…§å®¹å‰‡ä¿ç•™æç¤º
          if (!textarea.value.trim()) hint.textContent = "";
        };

        recog.onerror = (e) => {
          listening = false;
          btn.textContent = "ğŸ¤ é–‹å§‹éŒ„éŸ³";
          hint.textContent = "èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š" + e.error;
          console.error(e);
        };
      })();
    </script>
  </body>
</html>
